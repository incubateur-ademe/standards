generator client {
    provider        = "prisma-client"
    output          = "../src/generated/prisma"
    previewFeatures = ["typedSql", "views", "fullTextSearchPostgres"]
}

datasource db {
    provider = "postgresql"
}

// The catalog exposes `Action` entries. Each `Action` carries three phase properties
// (could/should/must) represented as relations to `Phase`, and a `standards`
// multi-select stored as a string array.

/// Action entries linked from Standards.
model Action {
    /// @notion(false)
    id String @id @default(cuid())

    /// Unique identifier from Notion (e.g. "ACT4")
    /// @notion("ID")
    notionId String? @unique

    /// Title of the action page
    /// @notion("Action")
    title String?

    /// Description (from Notion page content)
    /// @notion(current.content)
    description String?

    /// KPI / Mesure
    /// @notion("KPI / Mesure")
    kpi String?

    /// Pourquoi ? (reason)
    /// @notion("Pourquoi ?")
    reason String?

    /// Free URLs extracted from Notion source property
    /// @notion("Source")
    sourcesUrls String[]

    /// Relation to ActionSource pages (if present in Notion)
    /// @notion("Type source")
    sources ActionSource[] @relation("ActionToActionSource")

    /// @notion("Standard Beta")
    standardBeta String?

    /// @notion(false)
    createdAt DateTime @default(now())
    /// @notion(false)
    updatedAt DateTime @updatedAt

    /// Roles / métiers attendus pour cette `Action` (Notion multi-select)
    /// @notion("Métier(s)")
    roles Job[]

    /// Phase prioritaires (MoSCoW) définies sur l'`Action`
    couldHavePhaseId  String?
    shouldHavePhaseId String?
    mustHavePhaseId   String?

    couldHavePhase  Phase? @relation("ActionPhaseCouldHave", fields: [couldHavePhaseId], references: [id])
    shouldHavePhase Phase? @relation("ActionPhaseShouldHave", fields: [shouldHavePhaseId], references: [id])
    mustHavePhase   Phase? @relation("ActionPhaseMustHave", fields: [mustHavePhaseId], references: [id])

    /// Standards (catégories) — multi-select depuis Notion
    standards String[]

    actionProgresses         ActionProgress[]
    snapshotActionProgresses SnapshotActionProgress[]

    // @@fulltext([title])
    // @@fulltext([description])
    // @@fulltext([title, description])

    @@index([couldHavePhaseId])
    @@index([shouldHavePhaseId])
    @@index([mustHavePhaseId])
}

model ActionSource {
    /// @notion(false)
    id String @id @default(cuid())

    /// Name of the source (got from "Select".name property in Notion)
    /// @notion("Type source")
    name String?

    /// Description
    /// @notion(false)
    description String?

    /// Definition URL of the source
    /// @notion(false)
    url String?

    /// @notion(false)
    createdAt DateTime @default(now())
    /// @notion(false)
    updatedAt DateTime @updatedAt

    /// Back relation to Action
    /// @notion(false)
    actions Action[] @relation("ActionToActionSource")
}

/// Domain entries (formerly "Métier").
model Job {
    /// @notion(false)
    id String @id @default(cuid())

    /// Job / role name (got from Notion page title)
    /// @notion(current.title)
    name String?

    /// Job / role description (from Notion page content)
    /// @notion(current.content)
    description String?

    /// Unique identifier from Notion for this Job page
    notionId String?

    /// Manager: linked to `User` in Prisma (not imported from Notion)
    /// @notion(false)
    managerId String?
    manager   User?   @relation("JobManager", fields: [managerId], references: [id])

    /// Back relation to actions — Notion relation `Métier(s)`
    /// @notion(false)
    actions Action[]
}

/// Phase entries used by multiple phase relations.
model Phase {
    /// @notion(false)
    id String @id @default(cuid())

    /// Phase name (got from Notion page title)
    /// @notion(current.title)
    name String?

    /// Description (from Notion page content)
    /// @notion(current.content)
    description String?

    /// Unique identifier from Notion for this Phase page
    notionId String?

    /// Link to a source document
    /// @notion("Source doc beta")
    sourceDocBetaUrl String?

    /// Back relations to actions for the different phase properties
    /// @notion(false)
    actionsCouldHave  Action[]        @relation("ActionPhaseCouldHave")
    /// @notion(false)
    actionsShouldHave Action[]        @relation("ActionPhaseShouldHave")
    /// @notion(false)
    actionsMustHave   Action[]        @relation("ActionPhaseMustHave")
    startupShadows    StartupShadow[]
    snapshots         Snapshot[]
}

enum UserStatus {
    ACTIVE
    BLOCKED
    DELETED
}

enum UserRole {
    USER
    ADMIN
    REVIEWER
}

model User {
    id            String     @id @default(cuid())
    name          String?
    email         String     @unique
    emailVerified DateTime?
    image         String?
    username      String     @unique
    status        UserStatus @default(ACTIVE)
    role          UserRole   @default(USER)

    accounts       Account[]
    sessions       Session[]
    authenticators Authenticator[]

    createdAt               DateTime         @default(now())
    updatedAt               DateTime         @updatedAt
    managedJobs             Job[]            @relation("JobManager")
    userOnStartups          UserOnStartup[]
    ownedActionProgresses   ActionProgress[] @relation("ActionProgressOwner")
    updatedActionProgresses ActionProgress[] @relation("ActionProgressUpdatedBy")
    actionProofs            ActionProof[]    @relation("ActionProofCreatedBy")
    actionComments          ActionComment[]  @relation("ActionCommentCreatedBy")
    snapshots               Snapshot[]
}

model StartupShadow {
    id String @id @default(cuid())

    /// ID externe (API incubateur)
    externalId String @unique

    name String?

    /// Phase courante (issue de l’API externe, mappée à ton Phase interne)
    currentPhaseId String?
    currentPhase   Phase?  @relation(fields: [currentPhaseId], references: [id])

    /// Overrides locaux (assistance, audit, etc.)
    accessGrants UserOnStartup[]

    actionProgresses ActionProgress[]
    snapshots        Snapshot[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([currentPhaseId])
}

enum StartupAccessKind {
    ASSISTANCE
    AUDIT
    TEMP
    OTHER
}

model UserOnStartup {
    id String @id @default(cuid())

    startupShadowId String
    startupShadow   StartupShadow @relation(fields: [startupShadowId], references: [id], onDelete: Cascade)

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    kind   StartupAccessKind @default(ASSISTANCE)
    /// optionnel : justification libre
    reason String?

    /// optionnel : accès temporaire
    expiresAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([startupShadowId, userId, kind])
    @@index([userId])
    @@index([expiresAt])
}

// NextAuth
model Account {
    id                 String    @id @default(cuid())
    userId             String
    providerType       String
    providerId         String
    providerAccountId  String
    refreshToken       String?
    accessToken        String?
    accessTokenExpires DateTime?
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
    user               User      @relation(fields: [userId], references: [id])

    @@unique([providerId, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    userId       String
    expires      DateTime
    sessionToken String   @unique
    accessToken  String   @unique
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
    user         User     @relation(fields: [userId], references: [id])
}

model VerificationRequest {
    id         String   @id @default(cuid())
    identifier String
    token      String   @unique
    expires    DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([identifier, token])
}

// Optional for WebAuthn support
model Authenticator {
    credentialID         String  @unique
    userId               String
    providerAccountId    String
    credentialPublicKey  String
    counter              Int
    credentialDeviceType String
    credentialBackedUp   Boolean
    transports           String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@id([userId, credentialID])
}

enum ActionStatus {
    TODO
    IN_PROGRESS
    DONE
    BLOCKED
}

enum ProofKind {
    URL
    FILE
    NOTE
}

model ActionProgress {
    id String @id @default(cuid())

    startupShadowId String
    startupShadow   StartupShadow @relation(fields: [startupShadowId], references: [id], onDelete: Cascade)

    actionId String
    action   Action @relation(fields: [actionId], references: [id], onDelete: Cascade)

    status ActionStatus @default(TODO)

    ownerId String?
    owner   User?   @relation("ActionProgressOwner", fields: [ownerId], references: [id])

    updatedById String?
    updatedBy   User?   @relation("ActionProgressUpdatedBy", fields: [updatedById], references: [id])

    proofs   ActionProof[]
    comments ActionComment[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([startupShadowId, actionId])
    @@index([startupShadowId])
    @@index([actionId])
    @@index([status])
    @@index([ownerId])
}

model ActionProof {
    id String @id @default(cuid())

    actionProgressId String
    actionProgress   ActionProgress @relation(fields: [actionProgressId], references: [id], onDelete: Cascade)

    kind ProofKind @default(URL)

    /// URL ou clé S3 (ou autre stockage)
    ref String?

    /// Contexte/label/description
    note String?

    createdById String?
    createdBy   User?   @relation("ActionProofCreatedBy", fields: [createdById], references: [id])

    createdAt DateTime  @default(now())
    deletedAt DateTime?

    @@index([actionProgressId, createdAt])
    @@index([deletedAt])
    @@index([createdById])
}

model ActionComment {
    id String @id @default(cuid())

    actionProgressId String
    actionProgress   ActionProgress @relation(fields: [actionProgressId], references: [id], onDelete: Cascade)

    body String

    createdById String?
    createdBy   User?   @relation("ActionCommentCreatedBy", fields: [createdById], references: [id])

    /// Snapshot du rôle applicatif au moment de l’écriture
    authorRole UserRole?

    createdAt DateTime  @default(now())
    deletedAt DateTime?

    @@index([actionProgressId, createdAt])
    @@index([deletedAt])
    @@index([createdById])
}

model Snapshot {
    id String @id @default(cuid())

    startupShadowId String
    startupShadow   StartupShadow @relation(fields: [startupShadowId], references: [id], onDelete: Cascade)

    /// Phase courante au moment du snapshot
    phaseId String
    phase   Phase? @relation(fields: [phaseId], references: [id])

    createdById String?
    createdBy   User?   @relation(fields: [createdById], references: [id])

    createdAt DateTime @default(now())

    items SnapshotActionProgress[]

    @@index([startupShadowId, createdAt])
    @@index([phaseId])
}

model SnapshotActionProgress {
    id String @id @default(cuid())

    snapshotId String
    snapshot   Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

    actionId String
    action   Action @relation(fields: [actionId], references: [id])

    status ActionStatus

    proofs SnapshotActionProof[]

    @@unique([snapshotId, actionId])
    @@index([snapshotId])
    @@index([actionId])
}

model SnapshotActionProof {
    id String @id @default(cuid())

    snapshotActionProgressId String
    snapshotActionProgress   SnapshotActionProgress @relation(fields: [snapshotActionProgressId], references: [id], onDelete: Cascade)

    kind ProofKind
    ref  String?
    note String?

    createdAt DateTime @default(now())

    @@index([snapshotActionProgressId])
}
